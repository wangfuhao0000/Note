## 服务治理

服务治理主要包括各个微服务实例的**自动注册**与**发现**。

- **服务注册**：通常有一个服务中心，然后每个服务单元都向注册中心注册自己提供的服务，并将主机与端口号、版本号、通信协议等一系列的附加信息通知注册中心。注册中心按照**服务名**来分类组织服务清单。同时服务注册中心还会以**心跳方式**去监测清单中的服务是否可用，若不可用则及时地从服务清单中剔除，避免被调用（RocketMQ相反是客户端向注册中心或者说NameServer去注册）。
- **服务发现**：服务治理框架下都是通过**服务名**进行调用，而调用者不知道服务提供者实例的具体信息如IP地址。因此调用方需要向服务注册中心咨询服务，获取所有服务的实例清单，来实现对具体服务实例的访问。实际框架为了性能因素，不会每次调用时都向注册中心进行询问，而是会有一些**缓存**和**服务剔除**等机制。

## Netflix Eureka

Spring Cloud Eureka使用Netflix Eureka来实现服务注册与发现，它既包含了服务端组件，也包含了客户端组件：

- Eureka服务端：也叫服务注册中心，支持高可用配置。如果Eureka以集群模式部署，当集群中有分片出现故障时，Eureka会转入自我保护模式。允许在分片故障期间继续提供服务的发现和注册，当故障分片恢复运行时，集群中的其他分片会把他们的状态再次同步回来。
- Eureka客户端：主要处理服务的注册与发现，客户端服务通过**注解**和**参数配置**的方式嵌入到客户端。应用运行时Eureka客户端向注册中心注册自身提供的服务并发送周期性的心跳来更新它的服务租约。同时，它也可以从服务端查询当前注册的服务信息并缓存到本地并周期性更新服务状态。

## Eureka详解

### 基础架构

Eureka服务治理体系中的三个核心角色：服务注册中心，服务提供者以及服务消费者：

- **服务注册中心**：Eureka提供的服务端，提供服务注册与发现的功能
- **服务提供者**：提供服务的应用，它将自己提供的服务注册到Eureka，以供其它应用发现。
- **服务消费者**：消费者应用从服务注册中心获取到服务服务列表，从而可以知道去何处调用其所需要的服务。

### 服务提供者

#### 服务注册

“服务提供者”启动时通过发送REST请求将自己注册到Eureka Server上，并附带自己的一些元信息。Eureka接收到请求后将元数据信息存储在一个双层Map中，**第一层的key是服务名，第二层的key是具体服务的实例名**。

#### 服务同步

注册中心支局会互相注册为服务，昂服务提供者发送注册信息到一个服务注册中心时，它会将该请求转发给集群中相连的其他注册中心，从而实现注册中心之间的服务同步。

#### 服务续约

注册完服务后，服务提供者会维护一个心跳来告诉Eureka Server：我还活着，防止Eureka Server的将其从服务列表中剔除。服务续约有两个重要属性：

```properties
#服务续约的周期间隔
eureka.instance.lease-renewal-interval-in-seconds=30
#服务失效时间
eureka.instance.lease-expiration-duration-in-seconds=90
```

### 服务消费者

#### 获取服务

当启动一个服务消费者时，它会发送一个REST请求给服务注册中心，来获取上面注册的服务清单。为了性能考虑，Eureka-Server会维护一份只读的服务清单来返回给客户端，同时该缓存清单每隔30S更新一次。获取服务要保证参数`eureka-client.registry-fetch-registry=true`。

#### 服务调用

服务消费者获取到服务清单后，通过服务名就可以获得具体提供服务的实例名和其元数据信息，这样客户端就可根据需要来决定使用哪个实例。对于访问实例的选择，Eureka有Region和Zone的概念，一个Region中可包含多个Zone，每个服务客户端需要被注册到一个Zone中，所以每个客户端对应一个Region和一个Zone。**进行服务调用时，优先访问同处一个Zone中的服务提供方**。

#### 服务下线

当服务实例进行正常的关闭操作时，它会触发一个服务下线的REST请求给Eureka Server，告诉服务注册中心：我要下线。服务端收到请求后，将该服务设置为下线，**并把该下线事件传播出去**。

### 服务注册中心

#### 失效剔除

这种是真的服务出现故障无法提供服务时，注册中心需要及时的发现并剔除。Eureka Server启动时会创建一个定时任务，默认每隔一段时间将当前申请清单中超时没有续约的服务剔除出去。

#### 自我保护

Eureka Server运行时会统计心跳失败的比例在15分钟内是否低于85%，如果低于Eureka Server会将当前的实例注册信息保护起来，让这些实例不过期。但若保护期内实例出现问题，客户端很容易拿到已经不存在的服务实例，会出现调用失败的情况。所以客户端必须要有荣错机制